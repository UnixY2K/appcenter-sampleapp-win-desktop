.shared_windows_runners:
  tags:
    - shared-windows
    - windows
    - windows-1809

stages:
  - build
  - test
  - release
  - distribute

before_script:
  - choco feature enable -n allowGlobalConfirmation
  - choco upgrade dotnet-sdk --version=6.0.101 -y

build:
  extends:
    - .shared_windows_runners
  stage: build
  script:
    - choco install python --version=3.10.2 -y
    - $env:PATH+=";C:\Python310;C:\Python10\Scripts" # add to PATH without restart
    - python ./setup_config.py
    - cd Notes-Desktop
    - dotnet build
  artifacts:
    expire_in: 1 hour
    paths:
      - Notes-Desktop/bin
      - Notes-Desktop/obj

test:
  extends:
    - .shared_windows_runners
  dependencies:
    - build
  stage: test
  script:
    - cd Notes-Desktop
    - dotnet test

release:
  extends:
    - .shared_windows_runners
  dependencies:
    - build
  stage: release
  script:
    - cd Notes-Desktop
    - dotnet publish -r win-x64 -c Release --no-self-contained
    - Compress-Archive -Path .\bin\Release\net6.0-windows\win-x64\* -DestinationPath .\bin\release.zip
  artifacts:
    expire_in: never
    paths:
      - Notes-Desktop/bin/release.zip

distribute:
  extends:
    - .shared_windows_runners
  dependencies:
    - release
  stage: release
  before_script:
    - npm install -g appcenter-cli
  script:
    - Set-Variable -Name "time" -Value (date -Format "%H:%m")
    - appcenter distribute release -f .\Notes-Desktop\bin\release.zip --group "Public" --build-version {time} --release-notes-file .\changelist.md
